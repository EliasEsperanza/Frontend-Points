<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buscar</title>
    <link rel="stylesheet" href="/RamitaPrincipal/estilos/navbar.css" />
    <link rel="stylesheet" href="/RamitaPrincipal/estilos/footer.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="/RamitaPrincipal/estilos/buscar.css" />
  </head>
  <body>
    <!-----------------------SECCION NAVBAR MENU-------------------------------->
    <header>
      <div class="logo-container">
        <img src="/RamitaPrincipal/img/arbol.jpg" class="imgLogo" alt="" />
        <a href="#" class="Nombre">Ferreteria El Roble</a>
      </div>
      <ul class="links">
        <li><a href="/Inicio/html/index.html">Inicio</a></li>
        <li><a href="#" id="logout">cerrar Sesion</a></li>
        <li>
          <a href="/Perfil_Usuario/html/index.html">Perfil</a>
        </li>
        <li>
          <a href="/RamitaPrincipal/HTML/premios.html"
            >Premios</a
          >
        </li>
        <li>
          <a href="/RamitaPrincipal/HTML/puntos.html">Puntos</a>
        </li>
        <li><a href="/RamitaPrincipal/HTML/beneficios.html">Beneficios</a></li>
      </ul>
      <div class="toggle_btn"><i class="fa-solid fa-bars"></i></div>
      <div class="close_btn"><i class="fa-solid fa-x"></i></div>
    </header>

    <main>
      <section class="Buscador" id="Buscador">
        <h1 class="title"><span>Buscar</span> Usuario</h1>
        <div class="box-buscador">
          <h1 class="text-input">Ingrese el dui del usario a buscar</h1>
          <form id="buscar-form">
            <input type="text" name="inputBuscar" placeholder="ejemplo: 06557586-6">
            <input type="submit" name="inputEnviar" value="buscar">
        </form>
        
        </div>

        <table>
          <tr id="header-table">
            <th>Nombre</th>
            <th>Dui</th>
            <th>Puntos</th>
            <th>Nivel</th>
            <th>Premio</th>
            <th>Estado</th>
            <th>Canjear</th>
          </tr>
        </table>
      </section>
    </main>
    <!-----------------------SECCION FOOTER-------------------------------->
    <footer>
      <div class="row">
        <div class="col">
          <img src="/RamitaPrincipal/img/Logo.jpg" class="logo" />
          <p>
            Como ferretería el roble, proveemos soluciones materiales y
            herramientas para la construcción, civil y pequeña industria,
            surtido completo y permanente a los clientes con un servicio
            oportuno.
          </p>
        </div>
        <div class="col">
          <h3>
            Contactos
            <div class="underline"><span></span></div>
          </h3>
          <p>Tel: 7220 6538</p>
          <p>Correo: ferreteriaelroble01@gmail.com</p>
          <p class="email-id">
            direccion: Carretera Panamericana km 138, colonia Maquilishuat,
            canton El Sitio, #66 San Miguel, San Miguel, El Salvador
          </p>
          <p>Horarios:</p>
          <p>Lunes a Viernes: 7:00 am - 5:00pm</p>
          <p>Sabado: 7:00 am - 12:00 MD</p>
        </div>
        <div class="col">
          <h3>
            Links
            <div class="underline"><span></span></div>
          </h3>
          <ul>
            <li><a href="/Inicio/html/index.html">Inicio</a></li>
            <li><a href="/Login/index.html">Iniciar Sesion</a></li>
            <li><a href="/Perfil_Usuario/html/index.html">Perfil</a></li>
            <li><a href="/RamitaPrincipal/HTML/premios.html">Premios</a></li>
            <li><a href="/RamitaPrincipal/HTML/puntos.html">Puntos</a></li>
            <li><a href="#BeneficiosP">Beneficios</a></li>
          </ul>
        </div>
        <div class="col">
          <h3>
            Comentarios
            <div class="underline"><span></span></div>
          </h3>
          <form>
            <i class="fa-regular fa-envelope"></i>
            <input
              type="email"
              placeholder="Escriba su correo y lo atenderemos"
              required
            />
            <button type="submit">
              <i class="fa-solid fa-arrow-right"></i>
            </button>
          </form>
          <div class="social-icons">
            <a href="https://www.facebook.com/LaferreteriaRoble"
              ><i class="fa-brands fa-facebook"></i
            ></a>
            <a
              href="https://wa.me/+50372206538?text=Hola%2C%20me%20gustaría%20obtener%20más%20información."
              target="_blank"
              ><i class="fa-brands fa-whatsapp"></i
            ></a>
          </div>
        </div>
      </div>
      <hr />
      <p class="copyright">
        Universidad de El salvador © 2024 - ALL Rights Reserved
      </p>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const baseUrl = 'https://backend-points-production.up.railway.app';
            const table = document.querySelector('table');
        
            // Función para obtener los usuarios y llenar la tabla al cargar la página
            function loadUsers() {
                fetch(`${baseUrl}/usuarios`)
                    .then(response => response.json())
                    .then(data => {
                        const usuarios = data.data;
                        usuarios.forEach(usuario => {
                            fetch(`${baseUrl}/cliente/${usuario.idCliente}`)
                                .then(response => response.json())
                                .then(clienteData => {
                                    const cliente = clienteData.data;
                                    fetch(`${baseUrl}/niveles/${usuario.idNivel}`)
                                        .then(response => response.json())
                                        .then(nivelData => {
                                            const nivel = nivelData.data;
                                            addRowToTable(cliente, usuario.puntos, nivel);
                                        });
                                });
                        });
                    })
                    .catch(error => console.error('Error fetching data:', error));
            }
        
            // Función para añadir una fila a la tabla
            function addRowToTable(cliente, puntos, nivel) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Nombre">${cliente.nombreCliente}</td>
                    <td data-label="Dui">${cliente.dui}</td>
                    <td data-label="Puntos">${puntos}</td>
                    <td data-label="Nivel">${nivel.descripcion}</td>
                    <td data-label="Premio"><select id="selectPremio${cliente.idCliente}"></select></td>
                    <td data-label="Estado">${puntos > 0 ? 'Disponible' : 'Vacio'}</td>
                    <td data-label="Canjear"><button class="btn-canjear">Canjear</button></td>
                `;
                table.appendChild(row);
        
                // Cargar premios para el nivel
                fetch(`${baseUrl}/premio/nivel/${nivel.idNivel}`)
                    .then(response => response.json())
                    .then(premios => {
                        const selectPremio = row.querySelector(`#selectPremio${cliente.idCliente}`);
                        premios.forEach(premio => {
                            const option = document.createElement('option');
                            option.value = premio.idPremio;
                            option.textContent = premio.nombrePremio;
                            selectPremio.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching premios:', error));
            }
        
            // Cargar usuarios al iniciar
            loadUsers();
        
            // Manejar la búsqueda por DUI
            const buscarForm = document.getElementById('buscar-form');
            buscarForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const dui = buscarForm.inputBuscar.value.trim();
                
                if (dui === '') {
                    // Si el campo de búsqueda está vacío, cargar todos los usuarios
                    table.querySelectorAll('tr:not(#header-table)').forEach(row => row.remove());
                    loadUsers();
                } else {
                    // Búsqueda por DUI
                    fetch(`${baseUrl}/cliente/dui/${dui}`)
                        .then(response => response.json())
                        .then(clienteData => {
                            const cliente = clienteData.data;
        
                            fetch(`${baseUrl}/usuarios`)
                                .then(response => response.json())
                                .then(usuariosData => {
                                    const usuario = usuariosData.data.find(u => u.idCliente === cliente.idCliente);
                                    
                                    if (usuario) {
                                        fetch(`${baseUrl}/niveles/${usuario.idNivel}`)
                                            .then(response => response.json())
                                            .then(nivelData => {
                                                const nivel = nivelData.data;
                                                // Limpiar la tabla antes de añadir el resultado
                                                table.querySelectorAll('tr:not(#header-table)').forEach(row => row.remove());
                                                addRowToTable(cliente, usuario.puntos, nivel);
                                            });
                                    } else {
                                        alert('Usuario no encontrado');
                                    }
                                });
                        })
                        .catch(error => {
                            console.error('Error fetching client by DUI:', error);
                            alert('Cliente no encontrado');
                        });
                }
            });
        });
        </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/Frontend-Points/RamitaPrincipal/js/navbar.js"></script>
    <script src="/Frontend-Points/Login/log_out.js" defer></script>
  </body>
</html>
